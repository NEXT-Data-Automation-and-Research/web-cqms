<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Active Users Dashboard | CQMS</title>
<meta name="description" content="Active Users Activity Dashboard">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAtOTYwIDk2MCA5NjAiIHdpZHRoPSIyNHB4IiBmaWxsPSIjMWY5ZTRiIj48cGF0aCBkPSJNMjAwLTEyMHEtMzMgMC01Ni41LTIzLjVUMTIwLTIwMHYtNTYwcTAtMzMgMjMuNS01Ni41VDIwMC04NDBoNTYwcTMzIDAgNTYuNSAyMy41VDg0MC03NjB2NTYwcTAgMzMtMjMuNSA1Ni41VDc2MC0xMjBIMjAwWm00OTEtODBoNjl2LTY5bC02OSA2OVptLTQ1NyAwaDczbDEyMC0xMjBoODVMNDUyLTIwMGg2NGwxMjAtMTIwaDg1TDU0MS0yMDBoNjVsMTIwLTEyMGgzNHYtNDQwSDIwMHY1MDlsNjktNjloODVMNDM0LTIwMFptNzItMjAwLTU2LTU2IDE3Ny0xNzcgODAgODAgMTQ3LTE0NyA1NiA1Ni0yMDMgMjA0LTgwLTgwLTEyMSAxMjBaIi8+PC9zdmc+">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="theme.css">
    <link rel="stylesheet" href="sidebar.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="env-config.js"></script>
    <script src="supabase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="auth-check.js"></script>
    <script src="confirmation-dialog.js"></script>
    <script src="load-sidebar.js"></script>
    <script src="dark-mode.js"></script>
    <script src="search.js"></script>
    <script src="form-validation.js"></script>
    <script src="timezone-utils.js"></script>
    <script src="date-filter-utils.js"></script>

    <style>
        .main-content {
            overflow-x: hidden;
            max-width: calc(100vw - var(--sidebar-collapsed)) !important;
            box-sizing: border-box;
            width: 100%;
        }
        
        .sidebar:not(.collapsed) ~ .main-content {
            max-width: calc(100vw - var(--sidebar-width)) !important;
        }

        .header-actions {
            display: flex;
            gap: 0.5625rem;
            flex-wrap: wrap;
            align-items: center;
            width: 100%;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.4688rem 0.75rem;
            background-color: var(--background-white);
            color: var(--text-color);
            border: 0.0469rem solid var(--border-light);
            border-radius: 0.375rem;
            font-size: 0.6562rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: var(--font-family);
        }

        .action-btn:hover {
            background-color: var(--gray-50);
            border-color: var(--primary-color);
        }

        .action-btn.active {
            background-color: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
        }

        /* KPI Cards */
        .kpi-grid {
            display: flex;
            flex-direction: row;
            gap: 1.125rem;
            margin-bottom: 1.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }
        
        .kpi-grid .kpi-card {
            flex: 1;
            min-width: 12rem;
            flex-shrink: 0;
        }

        .kpi-card {
            background-color: var(--background-white);
            border: 0.0469rem solid var(--border-light);
            border-radius: 0.5625rem;
            padding: 1.125rem;
            box-shadow: var(--shadow-sm);
            transition: box-shadow 0.2s ease;
        }

        .kpi-card:hover {
            box-shadow: var(--shadow-md);
        }

        .kpi-label {
            font-size: 0.6562rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.375rem;
        }

        .kpi-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 0.25rem;
        }

        .kpi-change {
            font-size: 0.5625rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .kpi-change.positive {
            color: var(--success-color);
        }

        .kpi-change.negative {
            color: var(--error-color);
        }

        /* Dashboard Cards */
        .dashboard-card {
            background-color: var(--background-white);
            border: 0.0469rem solid var(--border-light);
            border-radius: 0.5625rem;
            padding: 1.125rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.125rem;
        }

        .card-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-color);
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 18rem;
            margin-bottom: 1rem;
        }

        .chart-container.small {
            height: 18rem;
        }

        /* Activity Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5625rem;
            border-radius: 0.375rem;
            font-size: 0.5625rem;
            font-weight: 500;
        }

        .status-badge.very-active {
            background-color: rgba(26, 115, 62, 0.1);
            color: #1a733e;
        }

        .status-badge.active {
            background-color: rgba(31, 158, 235, 0.1);
            color: #1f9eeb;
        }

        .status-badge.moderate {
            background-color: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }

        .status-badge.inactive {
            background-color: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }

        /* Users Table */
        .users-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 100%;
        }

        .users-table th,
        .users-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 0.0469rem solid var(--border-light);
            font-size: 0.6562rem;
            white-space: nowrap;
        }

        .users-table th {
            font-weight: 600;
            color: var(--text-secondary);
            background-color: var(--gray-50);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .users-table td {
            color: var(--text-color);
        }

        .users-table tr:hover {
            background-color: var(--gray-50);
        }

        .users-table td:first-child {
            white-space: normal;
            min-width: 12rem;
        }

        .activity-count {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-weight: 500;
        }

        .activity-type {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.125rem 0.375rem;
            background-color: var(--gray-50);
            border-radius: 0.25rem;
            font-size: 0.5625rem;
            margin-right: 0.25rem;
        }

        /* Filter Panel */
        .filter-panel {
            display: none;
            background: var(--gray-50);
            border: 0.0469rem solid var(--border-light);
            border-radius: 0.375rem;
            padding: 1.125rem;
            margin-bottom: 1.5rem;
            grid-template-columns: repeat(auto-fit, minmax(10rem, 1fr));
            gap: 0.75rem;
        }

        .filter-panel.active {
            display: grid;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .filter-label {
            font-size: 0.5625rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .filter-select {
            padding: 0.375rem 0.5625rem;
            border: 0.0469rem solid var(--border-light);
            border-radius: 0.2812rem;
            font-size: 0.6562rem;
            font-family: var(--font-family);
            background-color: var(--background-white);
            color: var(--text-color);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .charts-row {
                flex-direction: column !important;
            }
            
            .charts-row .dashboard-card {
                min-width: 100% !important;
            }
            
            .kpi-grid {
                flex-wrap: wrap;
            }
            
            .kpi-grid .kpi-card {
                min-width: calc(50% - 0.5625rem);
            }
            
            .chart-container {
                height: 15rem;
            }
            
            .chart-container.small {
                height: 12rem;
            }
            
            .filter-panel {
                grid-template-columns: 1fr;
            }
            
            .header-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .action-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="page-header">
            <div>
                <h1 class="page-title">Users Dashboard</h1>
                <p class="page-subtitle">Monitor all users and their activity across the platform</p>
            </div>
            <div class="header-actions">
                <button class="action-btn" id="toggleFilters">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 4h12M4 8h8M6 12h4"/>
                    </svg>
                    Filters
                </button>
                <button class="action-btn" id="refreshBtn">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 8a7 7 0 0 1 14 0M8 1v6M8 9v6"/>
                    </svg>
                    Refresh
                </button>
            </div>
        </header>

        <!-- Filter Panel -->
        <div class="filter-panel" id="filterPanel">
            <div class="filter-group">
                <label class="filter-label">Time Period</label>
                <select class="filter-select" id="timePeriod">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                    <option value="365">Last year</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">User Status</label>
                <select class="filter-select" id="userStatusFilter">
                    <option value="all">All Users</option>
                    <option value="active">Active Users Only</option>
                    <option value="inactive">Inactive Users Only</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Activity Status</label>
                <select class="filter-select" id="activityStatus">
                    <option value="all">All Statuses</option>
                    <option value="very-active">Very Active (7 days)</option>
                    <option value="active">Active (30 days)</option>
                    <option value="moderate">Moderately Active (90 days)</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Role</label>
                <select class="filter-select" id="roleFilter">
                    <option value="all">All Roles</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Department</label>
                <select class="filter-select" id="departmentFilter">
                    <option value="all">All Departments</option>
                </select>
            </div>
        </div>

        <!-- Date-Specific Activity Section -->
        <div class="dashboard-card" style="margin-bottom: 1.5rem;">
            <div class="card-header">
                <div class="card-title">Activity on Specific Date</div>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                    <label class="filter-label">Select Date</label>
                    <input type="date" id="specificDate" class="filter-select" 
                           style="width: auto; min-width: 10rem;"
                           onchange="checkDateActivity()">
                </div>
                <div style="display: flex; align-items: flex-end; gap: 0.5rem;">
                    <button class="action-btn" onclick="setDateToToday()">Today</button>
                    <button class="action-btn" onclick="setDateToYesterday()">Yesterday</button>
                </div>
                <div style="flex: 1; display: flex; align-items: flex-end; gap: 1rem;">
                    <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                        <div style="font-size: 0.5625rem; color: var(--text-secondary);">Active Users on Selected Date</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);" id="dateActiveUsers">-</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                        <div style="font-size: 0.5625rem; color: var(--text-secondary);">Total Activities</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-color);" id="dateTotalActivities">-</div>
                    </div>
                </div>
            </div>
            <div id="dateActivityDetails" style="margin-top: 1rem; display: none;">
                <div style="font-size: 0.6562rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem;">
                    Users Active on <span id="selectedDateDisplay"></span>:
                </div>
                <div id="dateActiveUsersList" style="max-height: 10rem; overflow-y: auto; border: 0.0469rem solid var(--border-light); border-radius: 0.375rem; padding: 0.75rem;">
                    <!-- User list will be populated here -->
                </div>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Total Users</div>
                <div class="kpi-value" id="totalActiveUsers">-</div>
                <div class="kpi-change" id="totalActiveUsersChange">
                    <span id="activeInactiveBreakdown">Loading...</span>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Very Active (7 days)</div>
                <div class="kpi-value" id="veryActiveUsers">-</div>
                <div class="kpi-change" id="veryActiveUsersChange">
                    <span>Loading...</span>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Active (30 days)</div>
                <div class="kpi-value" id="activeUsers">-</div>
                <div class="kpi-change" id="activeUsersChange">
                    <span>Loading...</span>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Total Activities</div>
                <div class="kpi-value" id="totalActivities">-</div>
                <div class="kpi-change" id="totalActivitiesChange">
                    <span>Loading...</span>
                </div>
            </div>
        </div>

        <!-- All Charts in One Row -->
        <div class="charts-row" style="display: flex; flex-direction: row; gap: 1.125rem; margin-bottom: 1.5rem; overflow-x: auto; padding-bottom: 0.5rem;">
            <!-- Activity Status Distribution -->
            <div class="dashboard-card" style="flex: 1; min-width: 20rem;">
                <div class="card-header">
                    <div class="card-title">Activity Status Distribution</div>
                </div>
                <div class="chart-container small">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>

            <!-- Activity by Type -->
            <div class="dashboard-card" style="flex: 1; min-width: 20rem;">
                <div class="card-header">
                    <div class="card-title">Activity by Type</div>
                </div>
                <div class="chart-container small">
                    <canvas id="activityTypeChart"></canvas>
                </div>
            </div>

            <!-- Activity Over Time -->
            <div class="dashboard-card" style="flex: 1; min-width: 20rem;">
                <div class="card-header">
                    <div class="card-title">Activity Over Time</div>
                </div>
                <div class="chart-container small">
                    <canvas id="activityOverTimeChart"></canvas>
                </div>
            </div>

            <!-- Activity Breakdown by Department -->
            <div class="dashboard-card" style="flex: 1; min-width: 20rem;">
                <div class="card-header">
                    <div class="card-title">Activity by Department</div>
                </div>
                <div class="chart-container small">
                    <canvas id="departmentChart"></canvas>
                </div>
            </div>
        </div>

        <!-- All Users Table -->
        <div class="dashboard-card">
            <div class="card-header">
                <div class="card-title">All Users</div>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="text" id="userSearch" placeholder="Search users..." 
                           style="padding: 0.375rem 0.5625rem; border: 0.0469rem solid var(--border-light); 
                                  border-radius: 0.2812rem; font-size: 0.6562rem; width: 12rem;"
                           onkeyup="filterUsersTable()">
                    <select id="tableSort" style="padding: 0.375rem 0.5625rem; border: 0.0469rem solid var(--border-light); 
                                                  border-radius: 0.2812rem; font-size: 0.6562rem;"
                            onchange="filterUsersTable()">
                        <option value="activity-desc">Most Active First</option>
                        <option value="activity-asc">Least Active First</option>
                        <option value="name-asc">Name A-Z</option>
                        <option value="name-desc">Name Z-A</option>
                        <option value="recent-desc">Most Recent Activity</option>
                        <option value="recent-asc">Oldest Activity</option>
                    </select>
                </div>
            </div>
            <div id="topUsersTable">
                <div class="loading">Loading users...</div>
            </div>
            <div id="paginationControls" style="display: none; margin-top: 1rem; 
                                                display: flex; justify-content: space-between; 
                                                align-items: center; padding-top: 1rem; 
                                                border-top: 0.0469rem solid var(--border-light);">
                <div style="font-size: 0.6562rem; color: var(--text-secondary);">
                    Showing <span id="showingFrom">0</span> - <span id="showingTo">0</span> of <span id="totalUsersCount">0</span> users
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="action-btn" id="prevPage" onclick="changePage(-1)">Previous</button>
                    <span style="font-size: 0.6562rem; padding: 0.375rem 0.75rem; color: var(--text-color);">
                        Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                    </span>
                    <button class="action-btn" id="nextPage" onclick="changePage(1)">Next</button>
                </div>
            </div>
        </div>

    </main>

    <script>
        // Chart instances
        const charts = {
            status: null,
            activityType: null,
            activityOverTime: null,
            department: null
        };

        // Data storage
        let usersData = [];
        let filteredData = [];
        let allUsersData = []; // Store all users regardless of activity
        let currentPage = 1;
        const itemsPerPage = 25;

        // Wait for Supabase client to be initialized
        async function waitForSupabaseClient() {
            let attempts = 0;
            while (!window.supabaseClient && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            return window.supabaseClient;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await waitForSupabaseClient();
            if (!window.supabaseClient) {
                console.error('Supabase client not initialized');
                document.getElementById('topUsersTable').innerHTML = 
                    '<div class="empty-state">Error: Supabase client not initialized. Please refresh the page.</div>';
                return;
            }
            await loadUsersData();
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('toggleFilters').addEventListener('click', () => {
                document.getElementById('filterPanel').classList.toggle('active');
            });

            document.getElementById('refreshBtn').addEventListener('click', async () => {
                await loadUsersData();
            });

            document.getElementById('timePeriod').addEventListener('change', applyFilters);
            document.getElementById('userStatusFilter').addEventListener('change', applyFilters);
            document.getElementById('activityStatus').addEventListener('change', applyFilters);
            document.getElementById('roleFilter').addEventListener('change', applyFilters);
            document.getElementById('departmentFilter').addEventListener('change', applyFilters);
        }

        // Load users data from Supabase
        async function loadUsersData() {
            if (!window.supabaseClient) {
                console.error('Supabase client not available');
                await loadUsersDataDirect();
                return;
            }

            try {
                // Try RPC function first (if it exists)
                const { data, error } = await window.supabaseClient.rpc('get_active_users', {
                    days_back: parseInt(document.getElementById('timePeriod').value) || 30,
                    min_activity_count: 0
                });

                if (error) {
                    console.warn('RPC function not available, using direct query:', error);
                    // Fallback: try direct query
                    await loadUsersDataDirect();
                    return;
                }

                usersData = data || [];
                allUsersData = usersData; // Store all users
                applyFilters();
            } catch (err) {
                console.warn('Error with RPC, trying direct query:', err);
                await loadUsersDataDirect();
            }
        }

        // Fallback: Load data directly from view or calculate from source tables
        async function loadUsersDataDirect() {
            if (!window.supabaseClient) {
                console.error('Supabase client not available');
                document.getElementById('topUsersTable').innerHTML = 
                    '<div class="empty-state">Error: Supabase client not initialized.</div>';
                return;
            }

            try {
                // Always calculate from source tables to get ALL users
                const daysBack = parseInt(document.getElementById('timePeriod').value) || 30;
                usersData = await calculateActiveUsersFromSource(daysBack);
                allUsersData = usersData; // Store all users
                applyFilters();
            } catch (calcErr) {
                console.error('Error calculating from source:', calcErr);
                document.getElementById('topUsersTable').innerHTML = 
                    '<div class="empty-state">Error loading data. Please check your connection.</div>';
            }
        }

        // Calculate active users from source tables (fallback)
        async function calculateActiveUsersFromSource(daysBack) {
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - daysBack);

            // Get ALL users (not just active ones)
            const { data: users, error: usersError } = await window.supabaseClient
                .from('users')
                .select('email, name, role, department, is_active, last_login, login_count')
                .order('name', { ascending: true });

            if (usersError) throw usersError;

            // Get activity data from various tables
            const [assignments, audits, reversals, calibrations, aiAudits] = await Promise.all([
                window.supabaseClient
                    .from('audit_assignments')
                    .select('employee_email, created_at')
                    .gte('created_at', cutoffDate.toISOString()),
                window.supabaseClient
                    .from('fnchat_cfd_v4_0_v2')
                    .select('employee_email, submitted_at, acknowledgement_status_updated_at, audit_rated_at')
                    .gte('submitted_at', cutoffDate.toISOString()),
                window.supabaseClient
                    .from('reversal_requests')
                    .select('requested_by_email, requested_at')
                    .gte('requested_at', cutoffDate.toISOString()),
                window.supabaseClient
                    .from('calibration_results')
                    .select('participant_email, submitted_at')
                    .gte('submitted_at', cutoffDate.toISOString()),
                window.supabaseClient
                    .from('ai_audit_results')
                    .select('employee_email, created_at')
                    .gte('created_at', cutoffDate.toISOString())
            ]);

            // Aggregate activity by user
            const userActivity = {};
            
            users.forEach(user => {
                userActivity[user.email] = {
                    email: user.email,
                    name: user.name,
                    role: user.role,
                    department: user.department,
                    is_active: user.is_active,
                    last_login: user.last_login,
                    login_count: user.login_count,
                    audit_assignment_count: 0,
                    audit_submission_count: 0,
                    acknowledgement_count: 0,
                    rating_count: 0,
                    reversal_count: 0,
                    calibration_count: 0,
                    ai_audit_count: 0,
                    most_recent_activity: user.last_login ? new Date(user.last_login) : new Date(0)
                };
            });

            // Count activities
            assignments.data?.forEach(a => {
                if (userActivity[a.employee_email]) {
                    userActivity[a.employee_email].audit_assignment_count++;
                    const date = new Date(a.created_at);
                    if (date > userActivity[a.employee_email].most_recent_activity) {
                        userActivity[a.employee_email].most_recent_activity = date;
                    }
                }
            });

            audits.data?.forEach(a => {
                if (userActivity[a.employee_email]) {
                    userActivity[a.employee_email].audit_submission_count++;
                    if (a.acknowledgement_status_updated_at) {
                        userActivity[a.employee_email].acknowledgement_count++;
                    }
                    if (a.audit_rated_at) {
                        userActivity[a.employee_email].rating_count++;
                    }
                    const date = new Date(a.submitted_at);
                    if (date > userActivity[a.employee_email].most_recent_activity) {
                        userActivity[a.employee_email].most_recent_activity = date;
                    }
                }
            });

            reversals.data?.forEach(r => {
                if (userActivity[r.requested_by_email]) {
                    userActivity[r.requested_by_email].reversal_count++;
                    const date = new Date(r.requested_at);
                    if (date > userActivity[r.requested_by_email].most_recent_activity) {
                        userActivity[r.requested_by_email].most_recent_activity = date;
                    }
                }
            });

            calibrations.data?.forEach(c => {
                if (userActivity[c.participant_email]) {
                    userActivity[c.participant_email].calibration_count++;
                    const date = new Date(c.submitted_at);
                    if (date > userActivity[c.participant_email].most_recent_activity) {
                        userActivity[c.participant_email].most_recent_activity = date;
                    }
                }
            });

            aiAudits.data?.forEach(a => {
                if (userActivity[a.employee_email]) {
                    userActivity[a.employee_email].ai_audit_count++;
                    const date = new Date(a.created_at);
                    if (date > userActivity[a.employee_email].most_recent_activity) {
                        userActivity[a.employee_email].most_recent_activity = date;
                    }
                }
            });

            // Convert to array and calculate totals - include ALL users
            return Object.values(userActivity).map(user => {
                const total = user.audit_assignment_count + user.audit_submission_count + 
                             user.acknowledgement_count + user.rating_count + 
                             user.reversal_count + user.calibration_count + user.ai_audit_count;
                
                // Determine activity status
                const daysSinceActivity = user.most_recent_activity.getTime() > 0 
                    ? (Date.now() - user.most_recent_activity.getTime()) / (1000 * 60 * 60 * 24)
                    : 999; // Never active
                
                let activity_status = 'Inactive (>90 days)';
                if (daysSinceActivity <= 7) activity_status = 'Very Active (7 days)';
                else if (daysSinceActivity <= 30) activity_status = 'Active (30 days)';
                else if (daysSinceActivity <= 90) activity_status = 'Moderately Active (90 days)';
                else if (user.most_recent_activity.getTime() === 0) activity_status = 'Never Active';

                return {
                    ...user,
                    total_activity_count: total,
                    activity_status: activity_status,
                    most_recent_activity: user.most_recent_activity.toISOString()
                };
            }).sort((a, b) => new Date(b.most_recent_activity) - new Date(a.most_recent_activity));
        }

        // Apply filters
        function applyFilters() {
            const timePeriod = parseInt(document.getElementById('timePeriod').value) || 30;
            const userStatusFilter = document.getElementById('userStatusFilter').value;
            const activityStatus = document.getElementById('activityStatus').value;
            const roleFilter = document.getElementById('roleFilter').value;
            const departmentFilter = document.getElementById('departmentFilter').value;

            // Start with all users data
            let dataToFilter = allUsersData.length > 0 ? allUsersData : usersData;

            filteredData = dataToFilter.filter(user => {
                // User status filter (active/inactive)
                if (userStatusFilter === 'active' && !user.is_active) return false;
                if (userStatusFilter === 'inactive' && user.is_active) return false;

                // Time period filter (only apply if filtering by activity)
                if (activityStatus !== 'all' || userStatusFilter === 'active') {
                    const userDate = new Date(user.most_recent_activity);
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - timePeriod);
                    // Only filter by time if user has activity
                    if (user.most_recent_activity && userDate < cutoffDate && activityStatus !== 'all') {
                        return false;
                    }
                }

                // Activity status filter
                if (activityStatus !== 'all') {
                    const statusMap = {
                        'very-active': 'Very Active (7 days)',
                        'active': 'Active (30 days)',
                        'moderate': 'Moderately Active (90 days)',
                        'inactive': 'Inactive (>90 days)'
                    };
                    if (user.activity_status !== statusMap[activityStatus]) return false;
                }

                // Role filter
                if (roleFilter !== 'all' && user.role !== roleFilter) return false;

                // Department filter
                if (departmentFilter !== 'all' && user.department !== departmentFilter) return false;

                return true;
            });

            currentPage = 1; // Reset to first page when filters change
            updateKPIs();
            updateCharts();
            updateTopUsersTable();
            updateFilterOptions();
        }

        // Update KPI cards
        function updateKPIs() {
            const total = filteredData.length;
            const activeUsers = filteredData.filter(u => u.is_active).length;
            const inactiveUsers = filteredData.filter(u => !u.is_active).length;
            const veryActive = filteredData.filter(u => u.activity_status === 'Very Active (7 days)').length;
            const active = filteredData.filter(u => u.activity_status === 'Active (30 days)').length;
            const totalActivities = filteredData.reduce((sum, u) => sum + (u.total_activity_count || 0), 0);

            document.getElementById('totalActiveUsers').textContent = total;
            document.getElementById('veryActiveUsers').textContent = veryActive;
            document.getElementById('activeUsers').textContent = active;
            document.getElementById('totalActivities').textContent = totalActivities.toLocaleString();
            
            // Update breakdown
            const breakdownEl = document.getElementById('activeInactiveBreakdown');
            if (breakdownEl) {
                breakdownEl.innerHTML = `<span style="color: var(--success-color);">${activeUsers} active</span> / <span style="color: var(--text-secondary);">${inactiveUsers} inactive</span>`;
            }
        }

        // Update charts
        function updateCharts() {
            updateStatusChart();
            updateActivityTypeChart();
            updateActivityOverTimeChart();
            updateDepartmentChart();
        }

        // Status distribution chart
        function updateStatusChart() {
            const statusCounts = {
                'Very Active (7 days)': 0,
                'Active (30 days)': 0,
                'Moderately Active (90 days)': 0,
                'Inactive (>90 days)': 0
            };

            filteredData.forEach(user => {
                if (statusCounts.hasOwnProperty(user.activity_status)) {
                    statusCounts[user.activity_status]++;
                }
            });

            const ctx = document.getElementById('statusChart');
            if (charts.status) charts.status.destroy();

            charts.status = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            'rgba(26, 115, 62, 0.8)',
                            'rgba(31, 158, 235, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(108, 117, 125, 0.8)'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Activity type chart
        function updateActivityTypeChart() {
            const activityTypes = {
                'Audit Assignments': 0,
                'Audit Submissions': 0,
                'Acknowledgements': 0,
                'Ratings': 0,
                'Reversals': 0,
                'Calibrations': 0,
                'AI Audits': 0
            };

            filteredData.forEach(user => {
                activityTypes['Audit Assignments'] += user.audit_assignment_count || 0;
                activityTypes['Audit Submissions'] += user.audit_submission_count || 0;
                activityTypes['Acknowledgements'] += user.acknowledgement_count || 0;
                activityTypes['Ratings'] += user.rating_count || 0;
                activityTypes['Reversals'] += user.reversal_count || 0;
                activityTypes['Calibrations'] += user.calibration_count || 0;
                activityTypes['AI Audits'] += user.ai_audit_count || 0;
            });

            const ctx = document.getElementById('activityTypeChart');
            if (charts.activityType) charts.activityType.destroy();

            charts.activityType = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(activityTypes),
                    datasets: [{
                        label: 'Activity Count',
                        data: Object.values(activityTypes),
                        backgroundColor: 'rgba(31, 158, 235, 0.8)',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Activity over time chart
        function updateActivityOverTimeChart() {
            const days = parseInt(document.getElementById('timePeriod').value) || 30;
            const labels = [];
            const data = [];

            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                
                const dayStart = new Date(date);
                dayStart.setHours(0, 0, 0, 0);
                const dayEnd = new Date(date);
                dayEnd.setHours(23, 59, 59, 999);

                const count = filteredData.filter(user => {
                    const userDate = new Date(user.most_recent_activity);
                    return userDate >= dayStart && userDate <= dayEnd;
                }).length;

                data.push(count);
            }

            const ctx = document.getElementById('activityOverTimeChart');
            if (charts.activityOverTime) charts.activityOverTime.destroy();

            charts.activityOverTime = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Active Users',
                        data: data,
                        borderColor: 'rgba(31, 158, 235, 1)',
                        backgroundColor: 'rgba(31, 158, 235, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Department chart
        function updateDepartmentChart() {
            const deptCounts = {};
            filteredData.forEach(user => {
                const dept = user.department || 'Unknown';
                deptCounts[dept] = (deptCounts[dept] || 0) + 1;
            });

            const ctx = document.getElementById('departmentChart');
            if (charts.department) charts.department.destroy();

            charts.department = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(deptCounts),
                    datasets: [{
                        label: 'Active Users',
                        data: Object.values(deptCounts),
                        backgroundColor: 'rgba(26, 115, 62, 0.8)',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Update top users table
        function updateTopUsersTable() {
            filterUsersTable();
        }

        // Filter and sort users table
        function filterUsersTable() {
            const searchTerm = (document.getElementById('userSearch')?.value || '').toLowerCase();
            const sortBy = document.getElementById('tableSort')?.value || 'activity-desc';
            
            let displayData = [...filteredData];
            
            // Apply search filter
            if (searchTerm) {
                displayData = displayData.filter(user => 
                    (user.name || '').toLowerCase().includes(searchTerm) ||
                    (user.email || '').toLowerCase().includes(searchTerm) ||
                    (user.role || '').toLowerCase().includes(searchTerm) ||
                    (user.department || '').toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply sorting
            displayData.sort((a, b) => {
                switch(sortBy) {
                    case 'activity-desc':
                        return (b.total_activity_count || 0) - (a.total_activity_count || 0);
                    case 'activity-asc':
                        return (a.total_activity_count || 0) - (b.total_activity_count || 0);
                    case 'name-asc':
                        return (a.name || a.email || '').localeCompare(b.name || b.email || '');
                    case 'name-desc':
                        return (b.name || b.email || '').localeCompare(a.name || a.email || '');
                    case 'recent-desc':
                        return new Date(b.most_recent_activity || 0) - new Date(a.most_recent_activity || 0);
                    case 'recent-asc':
                        return new Date(a.most_recent_activity || 0) - new Date(b.most_recent_activity || 0);
                    default:
                        return 0;
                }
            });
            
            // Pagination
            const totalPages = Math.ceil(displayData.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedData = displayData.slice(startIndex, endIndex);
            
            // Update pagination controls
            document.getElementById('totalUsersCount').textContent = displayData.length;
            document.getElementById('showingFrom').textContent = displayData.length > 0 ? startIndex + 1 : 0;
            document.getElementById('showingTo').textContent = Math.min(endIndex, displayData.length);
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages || 1;
            document.getElementById('paginationControls').style.display = displayData.length > itemsPerPage ? 'flex' : 'none';
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
            
            renderUsersTable(paginatedData);
        }

        // Render users table
        function renderUsersTable(users) {

            if (users.length === 0) {
                document.getElementById('topUsersTable').innerHTML = 
                    '<div class="empty-state"><div class="empty-state-icon">ðŸ‘¥</div>No users found</div>';
                return;
            }

            const table = `
                <div style="overflow-x: auto;">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Role</th>
                                <th>Department</th>
                                <th>User Status</th>
                                <th>Activity Status</th>
                                <th>Total Activities</th>
                                <th>Last Activity</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(user => `
                                <tr style="${!user.is_active ? 'opacity: 0.7;' : ''}">
                                    <td>
                                        <div style="font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                                            ${user.name || user.email}
                                            ${!user.is_active ? '<span style="font-size: 0.5rem; color: var(--text-secondary);">(Inactive)</span>' : ''}
                                        </div>
                                        <div style="font-size: 0.5625rem; color: var(--text-secondary);">${user.email}</div>
                                    </td>
                                    <td>${user.role || 'N/A'}</td>
                                    <td>${user.department || 'N/A'}</td>
                                    <td>
                                        <span class="status-badge ${user.is_active ? 'active' : 'inactive'}">
                                            ${user.is_active ? 'Active' : 'Inactive'}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="status-badge ${getStatusClass(user.activity_status)}">
                                            ${user.activity_status || 'Never Active'}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="activity-count">
                                            ${user.total_activity_count || 0}
                                            ${getActivityBreakdown(user)}
                                        </div>
                                    </td>
                                    <td>${formatDate(user.most_recent_activity)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('topUsersTable').innerHTML = table;
        }

        // Change page
        function changePage(direction) {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                filterUsersTable();
            }
        }

        // Get status CSS class
        function getStatusClass(status) {
            if (!status) return 'inactive';
            if (status.includes('Very Active')) return 'very-active';
            if (status.includes('Active (30')) return 'active';
            if (status.includes('Moderately')) return 'moderate';
            return 'inactive';
        }

        // Get activity breakdown
        function getActivityBreakdown(user) {
            const activities = [];
            if (user.acknowledgement_count > 0) activities.push(`Ack: ${user.acknowledgement_count}`);
            if (user.rating_count > 0) activities.push(`Rate: ${user.rating_count}`);
            if (user.reversal_count > 0) activities.push(`Rev: ${user.reversal_count}`);
            if (activities.length === 0) return '';
            return `<div style="font-size: 0.5rem; color: var(--text-secondary); margin-top: 0.25rem;">${activities.join(', ')}</div>`;
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Set date to today
        function setDateToToday() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('specificDate').value = today;
            checkDateActivity();
        }

        // Set date to yesterday
        function setDateToYesterday() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            document.getElementById('specificDate').value = yesterday.toISOString().split('T')[0];
            checkDateActivity();
        }

        // Check activity on specific date
        async function checkDateActivity() {
            const dateInput = document.getElementById('specificDate');
            if (!dateInput.value) {
                document.getElementById('dateActiveUsers').textContent = '-';
                document.getElementById('dateTotalActivities').textContent = '-';
                document.getElementById('dateActivityDetails').style.display = 'none';
                return;
            }

            const selectedDate = new Date(dateInput.value);
            const startOfDay = new Date(selectedDate);
            startOfDay.setHours(0, 0, 0, 0);
            const endOfDay = new Date(selectedDate);
            endOfDay.setHours(23, 59, 59, 999);

            if (!window.supabaseClient) {
                console.error('Supabase client not available');
                return;
            }

            try {
                // Get all activities on the selected date from various tables
                const [assignments, audits, reversals, calibrations, aiAudits, acknowledgements, ratings] = await Promise.all([
                    window.supabaseClient
                        .from('audit_assignments')
                        .select('employee_email, created_at')
                        .gte('created_at', startOfDay.toISOString())
                        .lte('created_at', endOfDay.toISOString()),
                    window.supabaseClient
                        .from('fnchat_cfd_v4_0_v2')
                        .select('employee_email, submitted_at')
                        .gte('submitted_at', startOfDay.toISOString())
                        .lte('submitted_at', endOfDay.toISOString()),
                    window.supabaseClient
                        .from('reversal_requests')
                        .select('requested_by_email, requested_at')
                        .gte('requested_at', startOfDay.toISOString())
                        .lte('requested_at', endOfDay.toISOString()),
                    window.supabaseClient
                        .from('calibration_results')
                        .select('participant_email, submitted_at')
                        .gte('submitted_at', startOfDay.toISOString())
                        .lte('submitted_at', endOfDay.toISOString()),
                    window.supabaseClient
                        .from('ai_audit_results')
                        .select('employee_email, created_at')
                        .gte('created_at', startOfDay.toISOString())
                        .lte('created_at', endOfDay.toISOString()),
                    window.supabaseClient
                        .from('fnchat_cfd_v4_0_v2')
                        .select('employee_email, acknowledgement_status_updated_at')
                        .gte('acknowledgement_status_updated_at', startOfDay.toISOString())
                        .lte('acknowledgement_status_updated_at', endOfDay.toISOString())
                        .not('acknowledgement_status_updated_at', 'is', null),
                    window.supabaseClient
                        .from('fnchat_cfd_v4_0_v2')
                        .select('employee_email, audit_rated_at')
                        .gte('audit_rated_at', startOfDay.toISOString())
                        .lte('audit_rated_at', endOfDay.toISOString())
                        .not('audit_rated_at', 'is', null)
                ]);

                // Collect all unique user emails with their activities
                const userActivities = {};
                const activityCounts = {
                    assignments: 0,
                    submissions: 0,
                    reversals: 0,
                    calibrations: 0,
                    aiAudits: 0,
                    acknowledgements: 0,
                    ratings: 0
                };

                // Process assignments
                assignments.data?.forEach(a => {
                    if (!userActivities[a.employee_email]) {
                        userActivities[a.employee_email] = { activities: [] };
                    }
                    userActivities[a.employee_email].activities.push('Audit Assignment');
                    activityCounts.assignments++;
                });

                // Process audit submissions
                audits.data?.forEach(a => {
                    if (!userActivities[a.employee_email]) {
                        userActivities[a.employee_email] = { activities: [] };
                    }
                    userActivities[a.employee_email].activities.push('Audit Submission');
                    activityCounts.submissions++;
                });

                // Process reversals
                reversals.data?.forEach(r => {
                    if (!userActivities[r.requested_by_email]) {
                        userActivities[r.requested_by_email] = { activities: [] };
                    }
                    userActivities[r.requested_by_email].activities.push('Reversal Request');
                    activityCounts.reversals++;
                });

                // Process calibrations
                calibrations.data?.forEach(c => {
                    if (!userActivities[c.participant_email]) {
                        userActivities[c.participant_email] = { activities: [] };
                    }
                    userActivities[c.participant_email].activities.push('Calibration');
                    activityCounts.calibrations++;
                });

                // Process AI audits
                aiAudits.data?.forEach(a => {
                    if (!userActivities[a.employee_email]) {
                        userActivities[a.employee_email] = { activities: [] };
                    }
                    userActivities[a.employee_email].activities.push('AI Audit');
                    activityCounts.aiAudits++;
                });

                // Process acknowledgements
                acknowledgements.data?.forEach(a => {
                    if (!userActivities[a.employee_email]) {
                        userActivities[a.employee_email] = { activities: [] };
                    }
                    userActivities[a.employee_email].activities.push('Acknowledgement');
                    activityCounts.acknowledgements++;
                });

                // Process ratings
                ratings.data?.forEach(r => {
                    if (!userActivities[r.employee_email]) {
                        userActivities[r.employee_email] = { activities: [] };
                    }
                    userActivities[r.employee_email].activities.push('Rating');
                    activityCounts.ratings++;
                });

                // Get user details for active users
                const activeUserEmails = Object.keys(userActivities);
                const totalActivities = Object.values(activityCounts).reduce((sum, count) => sum + count, 0);

                // Update display
                document.getElementById('dateActiveUsers').textContent = activeUserEmails.length;
                document.getElementById('dateTotalActivities').textContent = totalActivities;
                document.getElementById('selectedDateDisplay').textContent = selectedDate.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });

                // Get user details
                if (activeUserEmails.length > 0) {
                    const { data: users } = await window.supabaseClient
                        .from('users')
                        .select('email, name, role, department')
                        .in('email', activeUserEmails);

                    const userMap = {};
                    users?.forEach(u => {
                        userMap[u.email] = u;
                    });

                    // Build user list
                    const userList = activeUserEmails.map(email => {
                        const user = userMap[email] || { email, name: email, role: 'N/A', department: 'N/A' };
                        const activities = userActivities[email].activities;
                        const activitySummary = activities.reduce((acc, act) => {
                            acc[act] = (acc[act] || 0) + 1;
                            return acc;
                        }, {});

                        return {
                            ...user,
                            activityCount: activities.length,
                            activitySummary
                        };
                    }).sort((a, b) => b.activityCount - a.activityCount);

                    // Display user list
                    const listHtml = `
                        <div style="display: grid; gap: 0.5rem;">
                            ${userList.map(user => `
                                <div style="display: flex; justify-content: space-between; align-items: center; 
                                            padding: 0.5rem; background-color: var(--gray-50); border-radius: 0.25rem;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500; font-size: 0.6562rem;">${user.name || user.email}</div>
                                        <div style="font-size: 0.5625rem; color: var(--text-secondary);">
                                            ${user.role} â€¢ ${user.department}
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: 600; font-size: 0.6562rem; color: var(--primary-color);">
                                            ${user.activityCount} ${user.activityCount === 1 ? 'activity' : 'activities'}
                                        </div>
                                        <div style="font-size: 0.5rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                            ${Object.entries(user.activitySummary).map(([act, count]) => 
                                                `${act}${count > 1 ? ` (${count})` : ''}`
                                            ).join(', ')}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;

                    document.getElementById('dateActiveUsersList').innerHTML = listHtml;
                    document.getElementById('dateActivityDetails').style.display = 'block';
                } else {
                    document.getElementById('dateActiveUsersList').innerHTML = 
                        '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">No users were active on this date</div>';
                    document.getElementById('dateActivityDetails').style.display = 'block';
                }

            } catch (error) {
                console.error('Error checking date activity:', error);
                document.getElementById('dateActiveUsers').textContent = 'Error';
                document.getElementById('dateTotalActivities').textContent = 'Error';
            }
        }

        // Update filter options
        function updateFilterOptions() {
            const roles = [...new Set(usersData.map(u => u.role).filter(Boolean))].sort();
            const departments = [...new Set(usersData.map(u => u.department).filter(Boolean))].sort();

            const roleSelect = document.getElementById('roleFilter');
            const deptSelect = document.getElementById('departmentFilter');

            // Update role options
            const currentRole = roleSelect.value;
            roleSelect.innerHTML = '<option value="all">All Roles</option>' + 
                roles.map(r => `<option value="${r}">${r}</option>`).join('');
            if (currentRole !== 'all' && roles.includes(currentRole)) {
                roleSelect.value = currentRole;
            }

            // Update department options
            const currentDept = deptSelect.value;
            deptSelect.innerHTML = '<option value="all">All Departments</option>' + 
                departments.map(d => `<option value="${d}">${d}</option>`).join('');
            if (currentDept !== 'all' && departments.includes(currentDept)) {
                deptSelect.value = currentDept;
            }
        }
    </script>
</body>
</html>

