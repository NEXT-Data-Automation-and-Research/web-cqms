<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Event Management | CQMS</title>
<meta name="description" content="Quality Management System - Event Management">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAtOTYwIDk2MCA5NjAiIHdpZHRoPSIyNHB4IiBmaWxsPSIjMWY5ZTRiIj48cGF0aCBkPSJNMjAwLTEyMHEtMzMgMC01Ni41LTIzLjVUMTIwLTIwMHYtNTYwcTAtMzMgMjMuNS01Ni41VDIwMC04NDBoNTYwcTMzIDAgNTYuNSAyMy41VDg0MC03NjB2NTYwcTAgMzMtMjMuNSA1Ni41VDc2MC0xMjBIMjAwWm00OTEtODBoNjl2LTY5bC02OSA2OVptLTQ1NyAwaDczbDEyMC0xMjBoODVMNDUyLTIwMGg2NGwxMjAtMTIwaDg1TDU0MS0yMDBoNjVsMTIwLTEyMGgzNHYtNDQwSDIwMHY1MDlsNjktNjloODVMNDM0LTIwMFptNzItMjAwLTU2LTU2IDE3Ny0xNzcgODAgODAgMTQ3LTE0NyA1NiA1Ni0yMDMgMjA0LTgwLTgwLTEyMSAxMjBaIi8+PC9zdmc+">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="theme.css">
    <link rel="stylesheet" href="sidebar.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#1a733e',
              'primary-dark': '#0d5e3a',
              'dark-forest': '#032816',
              'success': '#10b981',
              'warning': '#f59e0b',
              'error': '#ef4444',
            },
            fontFamily: {
              sans: ['Poppins', 'sans-serif'],
            },
          },
        },
      }
    </script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="env-config.js"></script>
    <script src="supabase-config.js"></script>
    <script src="auth-check.js"></script>
    <script src="confirmation-dialog.js"></script>
    <script src="load-sidebar.js"></script>
    <script src="dark-mode.js"></script>
    <script src="search.js"></script>
    <script src="form-validation.js"></script>
    <script src="keyboard-shortcuts.js"></script>
    <script src="timezone-utils.js"></script>
    <script src="date-filter-utils.js"></script>
<style>
  .main-content {
    background-color: #f8f7f2;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }

  /* Dark Mode Styles */
  [data-theme="dark"] .main-content {
    background-color: var(--background-color);
  }

  [data-theme="dark"] .bg-white {
    background-color: var(--background-white) !important;
  }

  [data-theme="dark"] .border-gray-200 {
    border-color: var(--border-light) !important;
  }

  [data-theme="dark"] .text-gray-900 {
    color: var(--text-color) !important;
  }

  [data-theme="dark"] .text-gray-600 {
    color: var(--text-secondary) !important;
  }

  [data-theme="dark"] .text-gray-500 {
    color: var(--text-muted) !important;
  }

  [data-theme="dark"] .hover\:bg-gray-50:hover {
    background-color: var(--gray-100) !important;
  }

  /* Event filter button hover states */
  .event-type-filter.active:hover {
    background-color: #0d5e3a !important; /* primary-dark */
  }

  .event-type-filter:not(.active):hover {
    background-color: #f9fafb !important; /* gray-50 */
  }

  /* Calendar View Styles */
  .view-toggle-btn {
    color: #6b7280;
    background-color: transparent;
  }

  .view-toggle-btn.active {
    background-color: #1a733e;
    color: white;
  }

  .view-toggle-btn:hover:not(.active) {
    background-color: #f3f4f6;
  }

  .calendar-day {
    min-height: 100px;
    background-color: white;
    padding: 0.25rem;
    position: relative;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .calendar-day:hover {
    background-color: #f9fafb;
  }

  .calendar-day.other-month {
    background-color: #f9fafb;
    color: #9ca3af;
  }

  .calendar-day.today {
    background-color: #eff6ff;
  }

  .calendar-day.today .day-number {
    background-color: #1a733e;
    color: white;
    border-radius: 50%;
    width: 1.75rem;
    height: 1.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
  }

  .calendar-day-number {
    font-size: 0.75rem;
    font-weight: 500;
    margin-bottom: 0.25rem;
    padding: 0.125rem;
  }

  .calendar-event {
    font-size: 0.625rem;
    padding: 0.125rem 0.25rem;
    margin-bottom: 0.125rem;
    border-radius: 0.125rem;
    cursor: pointer;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-weight: 500;
    transition: opacity 0.2s;
  }

  .calendar-event:hover {
    opacity: 0.8;
  }

  .calendar-event.session {
    background-color: #dbeafe;
    color: #1e40af;
  }

  .calendar-event.meeting {
    background-color: #e9d5ff;
    color: #6b21a8;
  }

  .calendar-event.feedback {
    background-color: #d1fae5;
    color: #065f46;
  }

  .calendar-event.training {
    background-color: #fed7aa;
    color: #9a3412;
  }

  .calendar-event-more {
    font-size: 0.625rem;
    color: #6b7280;
    padding: 0.125rem 0.25rem;
    cursor: pointer;
    font-weight: 500;
  }

  .calendar-event-more:hover {
    color: #1a733e;
  }

  /* Dark Mode Calendar */
  [data-theme="dark"] .calendar-day {
    background-color: var(--background-white);
  }

  [data-theme="dark"] .calendar-day:hover {
    background-color: var(--gray-100);
  }

  [data-theme="dark"] .calendar-day.other-month {
    background-color: var(--gray-100);
    color: var(--text-muted);
  }

  [data-theme="dark"] .calendar-day.today {
    background-color: rgba(26, 115, 62, 0.15);
  }

  [data-theme="dark"] .view-toggle-btn {
    color: var(--text-secondary);
  }

  [data-theme="dark"] .view-toggle-btn.active {
    background-color: #1a733e;
    color: white;
  }

  [data-theme="dark"] .view-toggle-btn:hover:not(.active) {
    background-color: var(--gray-100);
  }

  /* Quick Add Modal Dark Mode */
  [data-theme="dark"] #quickAddModal .bg-white {
    background-color: var(--background-white) !important;
  }

  [data-theme="dark"] #quickAddModal .border-gray-200,
  [data-theme="dark"] #quickAddModal .border-gray-300 {
    border-color: var(--border-light) !important;
  }

  [data-theme="dark"] #quickAddModal .text-gray-900 {
    color: var(--text-color) !important;
  }

  [data-theme="dark"] #quickAddModal .text-gray-700 {
    color: var(--text-secondary) !important;
  }

  [data-theme="dark"] #quickAddModal .text-gray-500 {
    color: var(--text-muted) !important;
  }

  [data-theme="dark"] #quickAddModal .hover\:bg-gray-50:hover,
  [data-theme="dark"] #quickAddModal .hover\:bg-gray-100:hover {
    background-color: var(--gray-100) !important;
  }

  [data-theme="dark"] #quickAddDropdown {
    background-color: var(--background-white);
    border-color: var(--border-light);
  }

  [data-theme="dark"] #quickAddDropdown .text-gray-700 {
    color: var(--text-secondary) !important;
  }

  [data-theme="dark"] #quickAddDropdown .hover\:bg-gray-100:hover {
    background-color: var(--gray-100) !important;
  }
</style>
</head>

<body>
<!-- Sidebar will be loaded dynamically by load-sidebar.js -->
 <main class="main-content" role="main">
    <div class="px-4 py-4 max-w-7xl mx-auto w-full">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h1 class="text-xl font-bold text-gray-900">Event Management</h1>
          <p id="eventScopeInfo" class="text-xs text-gray-500 mt-1"></p>
        </div>
        <button id="createEventBtn" class="px-4 py-2 bg-primary text-white text-sm font-semibold rounded hover:bg-primary-dark transition-colors flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          <span id="createEventBtnText">Create Event</span>
        </button>
      </div>

      <!-- View Toggle and Event Types Filter -->
      <div class="mb-4 flex items-center justify-between gap-4 flex-wrap">
        <div class="flex items-center gap-2 flex-wrap">
        <button class="event-type-filter active px-3 py-1.5 bg-primary text-white text-xs font-semibold rounded hover:bg-primary-dark transition-colors" data-type="all">
          All Events
        </button>
        <button class="event-type-filter px-3 py-1.5 bg-white text-gray-700 text-xs font-semibold rounded border border-gray-200 hover:bg-gray-50 transition-colors" data-type="session">
          Sessions
        </button>
        <button class="event-type-filter px-3 py-1.5 bg-white text-gray-700 text-xs font-semibold rounded border border-gray-200 hover:bg-gray-50 transition-colors" data-type="meeting">
          Meetings
        </button>
        <button class="event-type-filter px-3 py-1.5 bg-white text-gray-700 text-xs font-semibold rounded border border-gray-200 hover:bg-gray-50 transition-colors" data-type="feedback">
          Feedback Sessions
        </button>
        <button class="event-type-filter px-3 py-1.5 bg-white text-gray-700 text-xs font-semibold rounded border border-gray-200 hover:bg-gray-50 transition-colors" data-type="training">
          Training Session
        </button>
      </div>

        <!-- View Toggle -->
        <div class="flex items-center gap-2 bg-white border border-gray-200 rounded-lg p-1">
          <button id="listViewBtn" class="view-toggle-btn active px-3 py-1.5 text-xs font-semibold rounded transition-colors flex items-center gap-1.5" data-view="list">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
            List
          </button>
          <button id="calendarViewBtn" class="view-toggle-btn px-3 py-1.5 text-xs font-semibold rounded transition-colors flex items-center gap-1.5" data-view="calendar">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            Calendar
          </button>
        </div>
      </div>

      <!-- List View -->
      <div id="listView" class="bg-white rounded-lg border border-gray-200 shadow-sm">
        <div id="eventsList" class="divide-y divide-gray-200">
          <!-- Empty State -->
          <div class="px-4 py-12 text-center">
            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <p class="text-sm font-semibold text-gray-700 mb-1">No events scheduled</p>
            <p class="text-xs text-gray-500 mb-4">Create your first event to get started</p>
            <button onclick="document.getElementById('createEventBtn').click()" class="px-4 py-2 bg-primary text-white text-xs font-semibold rounded hover:bg-primary-dark transition-colors">
              Create Event
            </button>
          </div>
        </div>
      </div>

      <!-- Calendar View -->
      <div id="calendarView" class="hidden bg-white rounded-lg border border-gray-200 shadow-sm">
        <!-- Calendar Header -->
        <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
          <div class="flex items-center gap-4">
            <button id="prevMonthBtn" class="p-1.5 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
              </svg>
            </button>
            <button id="nextMonthBtn" class="p-1.5 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </button>
            <h2 id="calendarMonthYear" class="text-lg font-semibold text-gray-900">January 2024</h2>
            <button id="todayBtn" class="px-3 py-1.5 text-xs font-semibold text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors">
              Today
            </button>
          </div>
        </div>
        
        <!-- Calendar Grid -->
        <div class="p-4">
          <!-- Day Headers -->
          <div class="grid grid-cols-7 gap-px mb-1">
            <div class="text-center text-xs font-semibold text-gray-600 py-2">Sun</div>
            <div class="text-center text-xs font-semibold text-gray-600 py-2">Mon</div>
            <div class="text-center text-xs font-semibold text-gray-600 py-2">Tue</div>
            <div class="text-center text-xs font-semibold text-gray-600 py-2">Wed</div>
            <div class="text-center text-xs font-semibold text-gray-600 py-2">Thu</div>
            <div class="text-center text-xs font-semibold text-gray-600 py-2">Fri</div>
            <div class="text-center text-xs font-semibold text-gray-600 py-2">Sat</div>
          </div>
          
          <!-- Calendar Days -->
          <div id="calendarGrid" class="grid grid-cols-7 gap-px bg-gray-200">
            <!-- Calendar cells will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>
</main>

<!-- Create/Edit Event Modal -->
<div id="eventModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
    <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between sticky top-0 bg-white z-10">
      <h2 id="eventModalTitle" class="text-lg font-semibold text-gray-900">Create Event</h2>
      <button onclick="closeEventModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    
    <form id="eventForm" class="p-6 space-y-4">
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">Event Title *</label>
        <input type="text" id="eventTitle" required class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Enter event title">
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Event Type *</label>
          <select id="eventType" required class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
            <option value="">Select type</option>
            <option value="session">Session</option>
            <option value="meeting">Meeting</option>
            <option value="feedback">Feedback Session</option>
            <option value="training">Training Session</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Date *</label>
          <input type="date" id="eventDate" required class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Start Time *</label>
          <input type="time" id="eventStartTime" required class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">End Time *</label>
          <input type="time" id="eventEndTime" required class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
        </div>
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">Description</label>
        <textarea id="eventDescription" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Enter event description"></textarea>
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">Participants</label>
        <div class="relative">
          <div class="flex gap-2 mb-2">
            <input type="text" id="participantSearch" class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Type to search participants by name or email..." autocomplete="off">
            <div class="relative">
              <button type="button" id="quickAddBtn" class="px-3 py-2 bg-gray-100 text-gray-700 text-sm font-semibold rounded border border-gray-300 hover:bg-gray-200 transition-colors flex items-center gap-1.5" title="Quick Add by Group">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Quick Add
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </button>
              <div id="quickAddDropdown" class="hidden absolute right-0 mt-1 w-56 bg-white border border-gray-300 rounded-lg shadow-lg z-50">
                <div class="py-1">
                  <button type="button" class="quick-add-option w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2" onclick="showQuickAddOptions('channel')">
                    <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/>
                    </svg>
                    Add by Channel
                  </button>
                  <button type="button" class="quick-add-option w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2" onclick="showQuickAddOptions('team')">
                    <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    Add by Team
                  </button>
                  <button type="button" class="quick-add-option w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2" onclick="showQuickAddOptions('supervisor')">
                    <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    Add by Supervisor
                  </button>
                  <button type="button" class="quick-add-option w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2" onclick="showQuickAddOptions('quality_mentor')">
                    <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
                    </svg>
                    Add by Quality Mentor
                  </button>
                  <button type="button" class="quick-add-option w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2" onclick="showQuickAddOptions('country')">
                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Add by Country
                  </button>
                  <button type="button" class="quick-add-option w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2" onclick="showQuickAddOptions('role')">
                    <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                    Add by Role
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div id="participantDropdown" class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
            <!-- Autocomplete results will appear here -->
          </div>
          <div id="selectedParticipants" class="flex flex-wrap gap-2 mt-2 min-h-[2.5rem] p-2 border border-gray-300 rounded bg-white">
            <!-- Selected participants will appear here as tags -->
          </div>
        </div>
        <p class="text-xs text-gray-500 mt-1">Type to search or use Quick Add to add groups</p>
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">Google Meet Link</label>
        <div class="flex gap-2">
          <input type="text" id="eventMeetLink" class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="https://meet.google.com/xxx-xxxx-xxx or Meet ID">
          <button type="button" onclick="pasteMeetLink()" class="px-3 py-2 bg-gray-100 text-gray-700 text-sm font-semibold rounded border border-gray-300 hover:bg-gray-200 transition-colors flex items-center gap-1" title="Paste from clipboard">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            Paste
          </button>
          <button type="button" onclick="createMeetLink()" class="px-3 py-2 bg-blue-600 text-white text-sm font-semibold rounded hover:bg-blue-700 transition-colors flex items-center gap-1" title="Create new Google Meet link">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
            </svg>
            Create
          </button>
        </div>
        <p class="text-xs text-gray-500 mt-1">Enter full Google Meet URL or just the Meet ID (e.g., abc-defg-hij), or use the buttons above</p>
      </div>

      <div class="flex items-center gap-4 pt-4 border-t border-gray-200">
        <button type="submit" class="px-4 py-2 bg-primary text-white text-sm font-semibold rounded hover:bg-primary-dark transition-colors">
          Save Event
        </button>
        <button type="button" onclick="closeEventModal()" class="px-4 py-2 bg-white text-gray-700 text-sm font-semibold rounded border border-gray-300 hover:bg-gray-50 transition-colors">
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<!-- View Event Modal -->
<div id="viewEventModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
    <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between sticky top-0 bg-white z-10">
      <h2 class="text-lg font-semibold text-gray-900">Event Details</h2>
      <button onclick="closeViewEventModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    
    <div id="viewEventContent" class="p-6 space-y-4">
      <!-- Content will be populated by JavaScript -->
    </div>
    
    <div class="px-6 py-4 border-t border-gray-200 flex items-center justify-end gap-3">
      <button onclick="closeViewEventModal()" class="px-4 py-2 bg-white text-gray-700 text-sm font-semibold rounded border border-gray-300 hover:bg-gray-50 transition-colors">
        Close
      </button>
    </div>
  </div>
</div>

<!-- Quick Add Modal -->
<div id="quickAddModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[80vh] overflow-y-auto">
    <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between sticky top-0 bg-white z-10">
      <h2 id="quickAddModalTitle" class="text-lg font-semibold text-gray-900">Add by Group</h2>
      <button onclick="closeQuickAddModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    
    <div class="p-6">
      <input type="text" id="quickAddSearch" class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent mb-4" placeholder="Search..." autocomplete="off">
      <div id="quickAddOptionsList" class="space-y-1 max-h-96 overflow-y-auto">
        <!-- Options will be populated by JavaScript -->
      </div>
    </div>
  </div>
</div>

<script>
// Event Management State
let events = [];
let currentFilter = 'all';
let editingEventId = null;
let allUsers = []; // Store all users for autocomplete
let selectedParticipants = []; // Store selected participant objects

// Calendar View State
let currentView = 'list'; // 'list' or 'calendar'
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();

// Initialize
document.addEventListener('DOMContentLoaded', async function() {
  await initializeEventManagement();
});

async function initializeEventManagement() {
  setupEventListeners();
  await loadUsers();
  updateEventScopeInfo();
  await loadEvents();
  setupParticipantAutocomplete();
  updateCreateButtonText(); // Set initial button text
  // Initialize view state
  switchView('list');
  renderEvents();
}

function updateEventScopeInfo() {
  const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
  const isSuperAdmin = userInfo.role === 'Super Admin';
  const scopeInfo = document.getElementById('eventScopeInfo');
  
  if (scopeInfo) {
    if (isSuperAdmin) {
      scopeInfo.textContent = 'Viewing all events (Super Admin)';
      scopeInfo.classList.remove('text-gray-500');
      scopeInfo.classList.add('text-blue-600', 'font-medium');
    } else {
      scopeInfo.textContent = 'Viewing your events only';
      scopeInfo.classList.remove('text-blue-600', 'font-medium');
      scopeInfo.classList.add('text-gray-500');
    }
  }
}

function updateCreateButtonText() {
  const buttonText = document.getElementById('createEventBtnText');
  if (!buttonText) return;
  
  const buttonTexts = {
    'all': 'Create Event',
    'session': 'Create Session',
    'meeting': 'Create Meeting',
    'feedback': 'Create Feedback Session',
    'training': 'Create Training Session'
  };
  
  buttonText.textContent = buttonTexts[currentFilter] || 'Create Event';
}

function setupEventListeners() {
  // Create event button
  const createEventBtn = document.getElementById('createEventBtn');
  if (createEventBtn) {
    createEventBtn.addEventListener('click', () => {
      // Pass the current filter type to auto-fill the event type
      const eventType = currentFilter !== 'all' ? currentFilter : null;
      openEventModal(null, eventType);
    });
  }

  // View toggle buttons
  const listViewBtn = document.getElementById('listViewBtn');
  const calendarViewBtn = document.getElementById('calendarViewBtn');
  const listView = document.getElementById('listView');
  const calendarView = document.getElementById('calendarView');

  if (listViewBtn) {
    listViewBtn.addEventListener('click', () => switchView('list'));
  }
  if (calendarViewBtn) {
    calendarViewBtn.addEventListener('click', () => switchView('calendar'));
  }

  // Calendar navigation
  const prevMonthBtn = document.getElementById('prevMonthBtn');
  const nextMonthBtn = document.getElementById('nextMonthBtn');
  const todayBtn = document.getElementById('todayBtn');

  if (prevMonthBtn) {
    prevMonthBtn.addEventListener('click', () => navigateMonth(-1));
  }
  if (nextMonthBtn) {
    nextMonthBtn.addEventListener('click', () => navigateMonth(1));
  }
  if (todayBtn) {
    todayBtn.addEventListener('click', () => goToToday());
  }

  // Event type filters
  const filterButtons = document.querySelectorAll('.event-type-filter');
  filterButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      // Update active state
      filterButtons.forEach(b => {
        b.classList.remove('active', 'bg-primary', 'text-white', 'hover:bg-primary-dark');
        b.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50');
      });
      btn.classList.add('active', 'bg-primary', 'text-white', 'hover:bg-primary-dark');
      btn.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-50');
      
      // Update filter
      currentFilter = btn.dataset.type;
      updateCreateButtonText();
      renderEvents();
    });
  });

  // Event form submission
  const eventForm = document.getElementById('eventForm');
  if (eventForm) {
    eventForm.addEventListener('submit', handleEventSubmit);
  }
  
  // Quick Add button
  setupQuickAddButton();
}

function setupQuickAddButton() {
  const quickAddBtn = document.getElementById('quickAddBtn');
  const quickAddDropdown = document.getElementById('quickAddDropdown');
  
  if (quickAddBtn && quickAddDropdown) {
    quickAddBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      quickAddDropdown.classList.toggle('hidden');
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!quickAddBtn.contains(e.target) && !quickAddDropdown.contains(e.target)) {
        quickAddDropdown.classList.add('hidden');
      }
    });
  }
  
  // Quick Add search
  const quickAddSearch = document.getElementById('quickAddSearch');
  if (quickAddSearch) {
    quickAddSearch.addEventListener('input', (e) => {
      filterQuickAddOptions(e.target.value);
    });
    
    // Close modal on Escape
    quickAddSearch.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeQuickAddModal();
      }
    });
  }
}

async function loadUsers() {
  try {
    if (!window.supabaseClient) {
      console.error('Supabase client not initialized');
      return;
    }

    const { data, error } = await window.supabaseClient
      .from('users')
      .select('email, name, role, department, channel, team, team_supervisor, quality_mentor, country')
      .eq('is_active', true)
      .order('name', { ascending: true });

    if (error) {
      console.error('Error loading users:', error);
      return;
    }

    allUsers = data || [];
  } catch (error) {
    console.error('Error loading users:', error);
    allUsers = [];
  }
}

function setupParticipantAutocomplete() {
  const searchInput = document.getElementById('participantSearch');
  const dropdown = document.getElementById('participantDropdown');
  const selectedContainer = document.getElementById('selectedParticipants');

  if (!searchInput || !dropdown || !selectedContainer) return;

  let highlightedIndex = -1;
  let filteredUsers = [];

  function renderDropdown(filtered) {
    filteredUsers = filtered;
    highlightedIndex = -1;

    if (filtered.length === 0) {
      dropdown.classList.add('hidden');
      return;
    }

    // Show dropdown with results
    dropdown.innerHTML = filtered.map((user, index) => `
      <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0 participant-option ${index === highlightedIndex ? 'bg-primary text-white' : ''}" data-user-index="${index}">
        <div class="font-medium text-sm ${index === highlightedIndex ? 'text-white' : 'text-gray-900'}">${escapeHtml(user.name || user.email)}</div>
        <div class="text-xs ${index === highlightedIndex ? 'text-white opacity-90' : 'text-gray-500'}">${escapeHtml(user.email)}</div>
        ${user.role ? `<div class="text-xs ${index === highlightedIndex ? 'text-white opacity-75' : 'text-gray-400'}">${escapeHtml(user.role)}${user.department ? ` â€¢ ${escapeHtml(user.department)}` : ''}</div>` : ''}
      </div>
    `).join('');

    // Add click handlers to each option
    dropdown.querySelectorAll('.participant-option').forEach((option, index) => {
      option.addEventListener('click', () => {
        selectParticipant(filtered[index]);
      });
    });

    dropdown.classList.remove('hidden');
  }

  function updateHighlight() {
    const options = dropdown.querySelectorAll('.participant-option');
    options.forEach((option, index) => {
      if (index === highlightedIndex) {
        option.classList.add('bg-primary', 'text-white');
        option.querySelector('.font-medium').classList.remove('text-gray-900');
        option.querySelector('.font-medium').classList.add('text-white');
        const emailDiv = option.querySelector('.text-xs');
        if (emailDiv && !emailDiv.classList.contains('text-white')) {
          emailDiv.classList.remove('text-gray-500');
          emailDiv.classList.add('text-white', 'opacity-90');
        }
        const roleDiv = option.querySelectorAll('.text-xs')[1];
        if (roleDiv && !roleDiv.classList.contains('text-white')) {
          roleDiv.classList.remove('text-gray-400');
          roleDiv.classList.add('text-white', 'opacity-75');
        }
        // Scroll into view
        option.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      } else {
        option.classList.remove('bg-primary', 'text-white');
        option.querySelector('.font-medium').classList.remove('text-white');
        option.querySelector('.font-medium').classList.add('text-gray-900');
        const emailDiv = option.querySelector('.text-xs');
        if (emailDiv) {
          emailDiv.classList.remove('text-white', 'opacity-90');
          emailDiv.classList.add('text-gray-500');
        }
        const roleDiv = option.querySelectorAll('.text-xs')[1];
        if (roleDiv) {
          roleDiv.classList.remove('text-white', 'opacity-75');
          roleDiv.classList.add('text-gray-400');
        }
      }
    });
  }

  // Handle input typing
  searchInput.addEventListener('input', (e) => {
    const query = e.target.value.trim().toLowerCase();
    
    if (query.length === 0) {
      dropdown.classList.add('hidden');
      highlightedIndex = -1;
      return;
    }

    // Filter users by name or email
    const filtered = allUsers.filter(user => {
      const name = (user.name || '').toLowerCase();
      const email = (user.email || '').toLowerCase();
      return name.includes(query) || email.includes(query);
    }).filter(user => {
      // Exclude already selected participants
      return !selectedParticipants.some(selected => selected.email === user.email);
    });

    renderDropdown(filtered);
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.classList.add('hidden');
      highlightedIndex = -1;
    }
  });

  // Handle keyboard navigation
  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      dropdown.classList.add('hidden');
      highlightedIndex = -1;
      searchInput.blur();
    } else if (e.key === 'ArrowDown') {
      e.preventDefault();
      if (filteredUsers.length > 0) {
        highlightedIndex = (highlightedIndex + 1) % filteredUsers.length;
        updateHighlight();
      }
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      if (filteredUsers.length > 0) {
        highlightedIndex = highlightedIndex <= 0 ? filteredUsers.length - 1 : highlightedIndex - 1;
        updateHighlight();
      }
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (highlightedIndex >= 0 && highlightedIndex < filteredUsers.length) {
        selectParticipant(filteredUsers[highlightedIndex]);
      } else if (filteredUsers.length > 0) {
        selectParticipant(filteredUsers[0]);
      }
    }
  });
}

// Quick Add Functions
let currentQuickAddType = null;

window.showQuickAddOptions = function(type) {
  currentQuickAddType = type;
  const modal = document.getElementById('quickAddModal');
  const modalTitle = document.getElementById('quickAddModalTitle');
  const optionsList = document.getElementById('quickAddOptionsList');
  const quickAddSearch = document.getElementById('quickAddSearch');
  const quickAddDropdown = document.getElementById('quickAddDropdown');
  
  if (!modal || !optionsList) return;
  
  // Close the quick add dropdown
  if (quickAddDropdown) {
    quickAddDropdown.classList.add('hidden');
  }
  
  // Set modal title
  const titles = {
    'channel': 'Add by Channel',
    'team': 'Add by Team',
    'supervisor': 'Add by Supervisor',
    'quality_mentor': 'Add by Quality Mentor',
    'country': 'Add by Country',
    'role': 'Add by Role'
  };
  if (modalTitle) {
    modalTitle.textContent = titles[type] || 'Add by Group';
  }
  
  // Get unique values for the selected type
  let uniqueValues = [];
  const fieldMap = {
    'channel': 'channel',
    'team': 'team',
    'supervisor': 'team_supervisor',
    'quality_mentor': 'quality_mentor',
    'country': 'country',
    'role': 'role'
  };
  
  const field = fieldMap[type];
  if (!field) return;
  
  // Get unique non-empty values
  const values = allUsers
    .map(user => user[field])
    .filter(value => value && value.trim() !== '')
    .filter((value, index, self) => self.indexOf(value) === index)
    .sort();
  
  // Render options
  renderQuickAddOptions(values, field);
  
  // Show modal
  modal.classList.remove('hidden');
  
  // Clear and focus search
  if (quickAddSearch) {
    quickAddSearch.value = '';
    setTimeout(() => quickAddSearch.focus(), 100);
  }
};

function renderQuickAddOptions(values, field) {
  const optionsList = document.getElementById('quickAddOptionsList');
  if (!optionsList) return;
  
  if (values.length === 0) {
    optionsList.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No options available</p>';
    return;
  }
  
  optionsList.innerHTML = values.map(value => {
    // Count members in this group
    const memberCount = allUsers.filter(user => user[field] === value).length;
    
    return `
      <button type="button" onclick="addGroupMembers('${escapeHtml(field)}', '${escapeHtml(value)}')" class="w-full text-left px-4 py-3 hover:bg-gray-50 border border-gray-200 rounded transition-colors">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <div class="font-medium text-sm text-gray-900">${escapeHtml(value)}</div>
            <div class="text-xs text-gray-500 mt-0.5">${memberCount} member${memberCount !== 1 ? 's' : ''}</div>
          </div>
          <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
        </div>
      </button>
    `;
  }).join('');
}

function filterQuickAddOptions(query) {
  const optionsList = document.getElementById('quickAddOptionsList');
  if (!optionsList || !currentQuickAddType) return;
  
  const fieldMap = {
    'channel': 'channel',
    'team': 'team',
    'supervisor': 'team_supervisor',
    'quality_mentor': 'quality_mentor',
    'country': 'country',
    'role': 'role'
  };
  
  const field = fieldMap[currentQuickAddType];
  if (!field) return;
  
  const searchQuery = query.toLowerCase().trim();
  
  // Get filtered unique values
  let values = allUsers
    .map(user => user[field])
    .filter(value => value && value.trim() !== '')
    .filter((value, index, self) => self.indexOf(value) === index);
  
  if (searchQuery) {
    values = values.filter(value => 
      value.toLowerCase().includes(searchQuery)
    );
  }
  
  values.sort();
  renderQuickAddOptions(values, field);
}

window.addGroupMembers = function(field, value) {
  // Find all users matching this field value
  const groupMembers = allUsers.filter(user => {
    const userValue = user[field];
    return userValue && userValue === value;
  });
  
  // Add all members to selected participants (avoid duplicates)
  let addedCount = 0;
  groupMembers.forEach(user => {
    if (!selectedParticipants.some(p => p.email === user.email)) {
      selectedParticipants.push(user);
      addedCount++;
    }
  });
  
  // Update UI
  renderSelectedParticipants();
  
  // Close modal
  closeQuickAddModal();
  
  // Show feedback
  if (addedCount > 0) {
    const quickAddBtn = document.getElementById('quickAddBtn');
    if (quickAddBtn) {
      const originalHTML = quickAddBtn.innerHTML;
      quickAddBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Added ${addedCount}`;
      quickAddBtn.classList.add('bg-green-600', 'text-white', 'border-green-600');
      quickAddBtn.classList.remove('bg-gray-100', 'text-gray-700', 'border-gray-300');
      setTimeout(() => {
        quickAddBtn.innerHTML = originalHTML;
        quickAddBtn.classList.remove('bg-green-600', 'text-white', 'border-green-600');
        quickAddBtn.classList.add('bg-gray-100', 'text-gray-700', 'border-gray-300');
      }, 2000);
    }
  }
};

function closeQuickAddModal() {
  const modal = document.getElementById('quickAddModal');
  const quickAddSearch = document.getElementById('quickAddSearch');
  if (modal) {
    modal.classList.add('hidden');
  }
  if (quickAddSearch) {
    quickAddSearch.value = '';
  }
  currentQuickAddType = null;
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
  const modal = document.getElementById('quickAddModal');
  if (modal && e.target === modal) {
    closeQuickAddModal();
  }
});

window.selectParticipant = function(user) {
  // Check if already selected
  if (selectedParticipants.some(p => p.email === user.email)) {
    return;
  }

  selectedParticipants.push(user);
  renderSelectedParticipants();
  
  // Clear search input and hide dropdown, but keep focus
  const searchInput = document.getElementById('participantSearch');
  const dropdown = document.getElementById('participantDropdown');
  if (searchInput) {
    searchInput.value = '';
    // Keep focus in the input field
    setTimeout(() => {
      searchInput.focus();
    }, 0);
  }
  if (dropdown) {
    dropdown.classList.add('hidden');
  }
}

window.removeParticipant = function(email) {
  selectedParticipants = selectedParticipants.filter(p => p.email !== email);
  renderSelectedParticipants();
}

window.pasteMeetLink = async function() {
  try {
    const text = await navigator.clipboard.readText();
    if (text) {
      const meetLinkInput = document.getElementById('eventMeetLink');
      if (meetLinkInput) {
        // If it's already a full URL, use it as is
        // If it's just a meet code, convert to full URL
        let meetLink = text.trim();
        if (meetLink && !meetLink.startsWith('http://') && !meetLink.startsWith('https://')) {
          // Assume it's a meet code, convert to full URL
          const meetId = meetLink.replace(/[^a-z0-9-]/gi, '');
          if (meetId) {
            meetLink = `https://meet.google.com/${meetId}`;
          }
        }
        meetLinkInput.value = meetLink;
        
        // Show success feedback
        const button = document.querySelector('button[onclick="pasteMeetLink()"]');
        if (button) {
          const originalHTML = button.innerHTML;
          button.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Pasted';
          button.classList.add('bg-green-600', 'hover:bg-green-700', 'text-white');
          button.classList.remove('bg-gray-100', 'hover:bg-gray-200', 'text-gray-700');
          setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('bg-green-600', 'hover:bg-green-700', 'text-white');
            button.classList.add('bg-gray-100', 'hover:bg-gray-200', 'text-gray-700');
          }, 1500);
        }
      }
    }
  } catch (error) {
    console.error('Error pasting from clipboard:', error);
    alert('Unable to paste from clipboard. Please make sure you have clipboard access permissions.');
  }
}

window.createMeetLink = function() {
  // Open Google Meet in a new tab so user can create a meeting
  window.open('https://meet.google.com', '_blank');
  
  // Show a helpful message
  const button = document.querySelector('button[onclick="createMeetLink()"]');
  if (button) {
    const originalHTML = button.innerHTML;
    button.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg> Opened';
    button.classList.add('bg-green-600', 'hover:bg-green-700');
    button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
    setTimeout(() => {
      button.innerHTML = originalHTML;
      button.classList.remove('bg-green-600', 'hover:bg-green-700');
      button.classList.add('bg-blue-600', 'hover:bg-blue-700');
    }, 2000);
  }
}

function renderSelectedParticipants() {
  const container = document.getElementById('selectedParticipants');
  if (!container) return;

  if (selectedParticipants.length === 0) {
    container.innerHTML = '<span class="text-xs text-gray-400 italic">No participants selected</span>';
    return;
  }

  container.innerHTML = selectedParticipants.map(user => `
    <span class="inline-flex items-center gap-1 px-2 py-1 bg-primary text-white text-xs font-medium rounded">
      ${escapeHtml(user.name || user.email)}
      <button type="button" onclick="removeParticipant('${escapeHtml(user.email)}')" class="hover:bg-primary-dark rounded p-0.5 transition-colors">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </span>
  `).join('');
}

function openEventModal(event = null, eventType = null) {
  const modal = document.getElementById('eventModal');
  const modalTitle = document.getElementById('eventModalTitle');
  const form = document.getElementById('eventForm');
  
  if (!modal || !form) return;
  
  editingEventId = event ? event.id : null;
  
  if (event) {
    modalTitle.textContent = 'Edit Event';
    document.getElementById('eventTitle').value = event.title || '';
    document.getElementById('eventType').value = event.type || '';
    document.getElementById('eventDate').value = event.date || '';
    document.getElementById('eventStartTime').value = event.start_time || '';
    document.getElementById('eventEndTime').value = event.end_time || '';
    document.getElementById('eventDescription').value = event.description || '';
    
    // Handle participants - load into selectedParticipants array
    selectedParticipants = [];
    if (event.participants) {
      let participantEmails = [];
      if (Array.isArray(event.participants)) {
        participantEmails = event.participants;
      } else if (typeof event.participants === 'string') {
        try {
          const parsed = JSON.parse(event.participants);
          participantEmails = Array.isArray(parsed) ? parsed : [event.participants];
        } catch {
          participantEmails = event.participants.split(',').map(e => e.trim()).filter(e => e);
        }
      }
      
      // Match emails with user objects
      selectedParticipants = participantEmails
        .map(email => allUsers.find(u => u.email === email))
        .filter(u => u !== undefined);
    }
    renderSelectedParticipants();
    document.getElementById('participantSearch').value = '';
    
    document.getElementById('eventMeetLink').value = event.meet_link || '';
  } else {
    modalTitle.textContent = 'Create Event';
    form.reset();
    selectedParticipants = [];
    
    // Auto-fill event type if provided (from filter button)
    if (eventType) {
      document.getElementById('eventType').value = eventType;
    }
    
    // Automatically add the event creator as a participant
    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
    if (userInfo && userInfo.email) {
      const creatorUser = allUsers.find(u => u.email === userInfo.email);
      if (creatorUser) {
        selectedParticipants.push(creatorUser);
      }
    }
    
    renderSelectedParticipants();
  }
  
  modal.classList.remove('hidden');
}

async function editEvent(eventId) {
  const event = events.find(e => e.id === eventId);
  if (!event) return;
  
  // Check if user can edit this event
  const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
  const isSuperAdmin = userInfo.role === 'Super Admin';
  const isOwner = event.created_by === userInfo.email;
  
  if (!isSuperAdmin && !isOwner) {
    if (window.confirmationDialog) {
      await window.confirmationDialog.show({
        title: 'Permission Denied',
        message: 'You can only edit events that you created.',
        confirmText: 'OK',
        cancelText: '',
        type: 'error'
      });
    } else {
    alert('You can only edit events that you created.');
    }
    return;
  }
  
  openEventModal(event);
}

function viewEvent(eventId) {
  const event = events.find(e => e.id === eventId);
  if (!event) return;
  
  const modal = document.getElementById('viewEventModal');
  const content = document.getElementById('viewEventContent');
  
  if (!modal || !content) return;
  
  const typeColors = {
    session: 'bg-blue-100 text-blue-800',
    meeting: 'bg-purple-100 text-purple-800',
    feedback: 'bg-green-100 text-green-800',
    training: 'bg-orange-100 text-orange-800'
  };
  
  const typeLabels = {
    session: 'Session',
    meeting: 'Meeting',
    feedback: 'Feedback Session',
    training: 'Training Session'
  };
  
  // Parse participants and match with user names
  let participantEmails = [];
  if (event.participants) {
    if (Array.isArray(event.participants)) {
      participantEmails = event.participants;
    } else if (typeof event.participants === 'string') {
      try {
        const parsed = JSON.parse(event.participants);
        participantEmails = Array.isArray(parsed) ? parsed : [];
      } catch {
        participantEmails = event.participants.split(',').map(p => p.trim()).filter(p => p);
      }
    }
  }
  
  // Match emails with user objects to get names
  const participantUsers = participantEmails
    .map(email => allUsers.find(u => u.email === email))
    .filter(u => u !== undefined);
  
  // Get creator name
  const creatorUser = event.created_by ? allUsers.find(u => u.email === event.created_by) : null;
  const creatorName = creatorUser ? (creatorUser.name || creatorUser.email) : (event.created_by || 'N/A');
  
  content.innerHTML = `
    <div>
      <label class="block text-xs font-semibold text-gray-500 mb-1">Event Title</label>
      <div class="flex items-center gap-2 mb-4">
        <h3 class="text-lg font-semibold text-gray-900">${escapeHtml(event.title)}</h3>
        <span class="px-2 py-1 rounded text-xs font-semibold ${typeColors[event.type] || 'bg-gray-100 text-gray-800'}">
          ${typeLabels[event.type] || event.type}
        </span>
      </div>
    </div>
    
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block text-xs font-semibold text-gray-500 mb-1">Date</label>
        <p class="text-sm text-gray-900">${formatDate(event.date)}</p>
      </div>
      <div>
        <label class="block text-xs font-semibold text-gray-500 mb-1">Time</label>
        <p class="text-sm text-gray-900">${event.start_time || 'N/A'} - ${event.end_time || 'N/A'}</p>
      </div>
    </div>
    
    ${event.description ? `
      <div>
        <label class="block text-xs font-semibold text-gray-500 mb-1">Description</label>
        <p class="text-sm text-gray-900 whitespace-pre-wrap">${escapeHtml(event.description)}</p>
      </div>
    ` : ''}
    
    ${participantUsers.length > 0 ? `
      <div>
        <label class="block text-xs font-semibold text-gray-500 mb-1">Participants</label>
        <div class="flex flex-wrap gap-2">
          ${participantUsers.map(user => `
            <span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">${escapeHtml(user.name || user.email)}</span>
          `).join('')}
        </div>
      </div>
    ` : ''}
    
    ${event.meet_link ? `
      <div>
        <label class="block text-xs font-semibold text-gray-500 mb-1">Google Meet Link</label>
        <a href="${escapeHtml(event.meet_link)}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded hover:bg-blue-700 transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
          </svg>
          Join Google Meet
        </a>
        <p class="text-xs text-gray-500 mt-1 break-all">${escapeHtml(event.meet_link)}</p>
      </div>
    ` : ''}
    
    <div class="pt-4 border-t border-gray-200">
      <label class="block text-xs font-semibold text-gray-500 mb-1">Created By</label>
      <p class="text-sm text-gray-900">${escapeHtml(creatorName)}</p>
      ${event.created_at ? `
        <p class="text-xs text-gray-500 mt-1">Created on ${formatDateTime(event.created_at)}</p>
      ` : ''}
    </div>
  `;
  
  modal.classList.remove('hidden');
}

function closeViewEventModal() {
  const modal = document.getElementById('viewEventModal');
  if (modal) {
    modal.classList.add('hidden');
  }
}

function formatDateTime(dateString) {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  return date.toLocaleString('en-US', { 
    month: 'short', 
    day: 'numeric', 
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

function closeEventModal() {
  const modal = document.getElementById('eventModal');
  if (modal) {
    modal.classList.add('hidden');
    editingEventId = null;
    document.getElementById('eventForm').reset();
    selectedParticipants = [];
    renderSelectedParticipants();
    document.getElementById('participantSearch').value = '';
    document.getElementById('participantDropdown').classList.add('hidden');
  }
  // Also close Quick Add modal if open
  closeQuickAddModal();
}

async function handleEventSubmit(e) {
  e.preventDefault();
  
  try {
    // Get current user from localStorage (same pattern as other pages)
    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
    if (!userInfo || !userInfo.email) {
      alert('You must be logged in to create events');
      return;
    }

    const title = document.getElementById('eventTitle').value.trim();
    const type = document.getElementById('eventType').value;
    const date = document.getElementById('eventDate').value;
    const startTime = document.getElementById('eventStartTime').value;
    const endTime = document.getElementById('eventEndTime').value;
    const description = document.getElementById('eventDescription').value.trim();
    const meetLinkInput = document.getElementById('eventMeetLink').value.trim();
    
    // Validate required fields
    if (!title || !type || !date || !startTime || !endTime) {
      alert('Please fill in all required fields');
      return;
    }

    // Validate time
    if (startTime >= endTime) {
      alert('End time must be after start time');
      return;
    }

    // Get participants from selectedParticipants array
    const participants = selectedParticipants.map(p => p.email);

    // Process meet link - convert Meet ID to full URL if needed
    let meetLink = null;
    if (meetLinkInput) {
      if (meetLinkInput.startsWith('http://') || meetLinkInput.startsWith('https://')) {
        meetLink = meetLinkInput;
      } else {
        // Assume it's a Meet ID, convert to full URL
        const meetId = meetLinkInput.replace(/[^a-z0-9-]/gi, ''); // Clean the ID
        if (meetId) {
          meetLink = `https://meet.google.com/${meetId}`;
        }
      }
    }

    const eventData = {
      title,
      type,
      date,
      start_time: startTime,
      end_time: endTime,
      description: description || null,
      participants: participants.length > 0 ? participants : null,
      meet_link: meetLink,
      created_by: userInfo.email
    };
    
    if (editingEventId) {
      await updateEvent(editingEventId, eventData);
    } else {
      await createEvent(eventData);
    }
    
    await loadEvents();
  closeEventModal();
  renderEvents();
  } catch (error) {
    console.error('Error saving event:', error);
    alert('Error saving event: ' + (error.message || 'Unknown error'));
  }
}

function renderEvents() {
  // If calendar view, render calendar instead
  if (currentView === 'calendar') {
    renderCalendar();
    return;
  }
  
  const eventsList = document.getElementById('eventsList');
  if (!eventsList) return;
  
  // Filter events
  let filteredEvents = events;
  if (currentFilter !== 'all') {
    filteredEvents = events.filter(event => event.type === currentFilter);
  }
  
  // Sort events by date and time (upcoming first)
  filteredEvents.sort((a, b) => {
    const dateA = new Date(`${a.date}T${a.start_time || '00:00'}`);
    const dateB = new Date(`${b.date}T${b.start_time || '00:00'}`);
    return dateA - dateB;
  });
  
  if (filteredEvents.length === 0) {
    const buttonTexts = {
      'all': 'Create Event',
      'session': 'Create Session',
      'meeting': 'Create Meeting',
      'feedback': 'Create Feedback Session',
      'training': 'Create Training Session'
    };
    const emptyStateButtonText = buttonTexts[currentFilter] || 'Create Event';
    
    const emptyStateMessages = {
      'all': 'No events scheduled',
      'session': 'No sessions scheduled',
      'meeting': 'No meetings scheduled',
      'feedback': 'No feedback session scheduled',
      'training': 'No training session scheduled'
    };
    const emptyStateMessage = emptyStateMessages[currentFilter] || 'No events scheduled';
    
    eventsList.innerHTML = `
      <div class="px-4 py-12 text-center">
        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
        <p class="text-sm font-semibold text-gray-700 mb-1">${emptyStateMessage}</p>
        <p class="text-xs text-gray-500 mb-4">Create your first event to get started</p>
        <button onclick="document.getElementById('createEventBtn').click()" class="px-4 py-2 bg-primary text-white text-xs font-semibold rounded hover:bg-primary-dark transition-colors">
          ${emptyStateButtonText}
        </button>
      </div>
    `;
    return;
  }
  
  eventsList.innerHTML = filteredEvents.map(event => {
    const typeColors = {
      session: 'bg-blue-100 text-blue-800',
      meeting: 'bg-purple-100 text-purple-800',
      feedback: 'bg-green-100 text-green-800',
      training: 'bg-orange-100 text-orange-800'
    };
    
    const typeLabels = {
      session: 'Session',
      meeting: 'Meeting',
      feedback: 'Feedback Session',
      training: 'Training Session'
    };

    // Parse participants - handle both array and string formats
    let participants = [];
    if (event.participants) {
      if (Array.isArray(event.participants)) {
        participants = event.participants;
      } else if (typeof event.participants === 'string') {
        try {
          const parsed = JSON.parse(event.participants);
          participants = Array.isArray(parsed) ? parsed : [];
        } catch {
          // If parsing fails, treat as comma-separated string
          participants = event.participants.split(',').map(p => p.trim()).filter(p => p);
        }
      }
    }
    const participantCount = participants.length;
    
    return `
      <div class="px-4 py-4 hover:bg-gray-50 transition-colors cursor-pointer" onclick="viewEvent('${event.id}')">
        <div class="flex items-center justify-between gap-4">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-2">
              <h3 class="text-sm font-semibold text-gray-900">${escapeHtml(event.title)}</h3>
              <span class="px-2 py-0.5 rounded text-[10px] font-semibold ${typeColors[event.type] || 'bg-gray-100 text-gray-800'}">
                ${typeLabels[event.type] || event.type}
              </span>
            </div>
            <p class="text-xs text-gray-600 mb-2">${escapeHtml(event.description || 'No description')}</p>
            <div class="flex items-center gap-4 text-xs text-gray-500 flex-wrap">
              <span class="flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                ${formatDate(event.date)}
              </span>
              <span class="flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                ${event.start_time || 'N/A'} - ${event.end_time || 'N/A'}
              </span>
              ${participantCount > 0 ? `
                <span class="flex items-center gap-1">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                  </svg>
                  ${participantCount} participant${participantCount !== 1 ? 's' : ''}
                </span>
              ` : ''}
            </div>
          </div>
          <div class="flex items-center gap-2" onclick="event.stopPropagation()">
            ${event.meet_link ? `
              <a href="${escapeHtml(event.meet_link)}" target="_blank" rel="noopener noreferrer" class="px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded hover:bg-blue-700 transition-colors flex items-center gap-2" title="Join Google Meet">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                </svg>
                Join
              </a>
            ` : ''}
            <button onclick="editEvent('${event.id}')" class="p-1.5 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded transition-colors" title="Edit">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
            </button>
            <button onclick="deleteEvent('${event.id}')" class="p-1.5 text-red-600 hover:text-red-900 hover:bg-red-50 rounded transition-colors" title="Delete">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function formatDate(dateString) {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

// Calendar View Functions
function switchView(view) {
  currentView = view;
  const listView = document.getElementById('listView');
  const calendarView = document.getElementById('calendarView');
  const listViewBtn = document.getElementById('listViewBtn');
  const calendarViewBtn = document.getElementById('calendarViewBtn');
  
  if (view === 'list') {
    listView?.classList.remove('hidden');
    calendarView?.classList.add('hidden');
    if (listViewBtn) {
      listViewBtn.classList.add('active');
      listViewBtn.style.backgroundColor = '#1a733e';
      listViewBtn.style.color = 'white';
    }
    if (calendarViewBtn) {
      calendarViewBtn.classList.remove('active');
      calendarViewBtn.style.backgroundColor = 'transparent';
      calendarViewBtn.style.color = '#6b7280';
    }
  } else {
    listView?.classList.add('hidden');
    calendarView?.classList.remove('hidden');
    if (calendarViewBtn) {
      calendarViewBtn.classList.add('active');
      calendarViewBtn.style.backgroundColor = '#1a733e';
      calendarViewBtn.style.color = 'white';
    }
    if (listViewBtn) {
      listViewBtn.classList.remove('active');
      listViewBtn.style.backgroundColor = 'transparent';
      listViewBtn.style.color = '#6b7280';
    }
    renderCalendar();
  }
  
  renderEvents();
}

function navigateMonth(direction) {
  currentMonth += direction;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear -= 1;
  } else if (currentMonth > 11) {
    currentMonth = 0;
    currentYear += 1;
  }
  renderCalendar();
}

function goToToday() {
  const today = new Date();
  currentMonth = today.getMonth();
  currentYear = today.getFullYear();
  renderCalendar();
}

function renderCalendar() {
  const calendarGrid = document.getElementById('calendarGrid');
  const monthYearEl = document.getElementById('calendarMonthYear');
  
  if (!calendarGrid) return;
  
  // Update month/year display
  if (monthYearEl) {
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                        'July', 'August', 'September', 'October', 'November', 'December'];
    monthYearEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;
  }
  
  // Get first day of month and number of days
  const firstDay = new Date(currentYear, currentMonth, 1);
  const lastDay = new Date(currentYear, currentMonth + 1, 0);
  const daysInMonth = lastDay.getDate();
  const startingDayOfWeek = firstDay.getDay();
  
  // Filter events for current month
  let filteredEvents = events;
  if (currentFilter !== 'all') {
    filteredEvents = events.filter(event => event.type === currentFilter);
  }
  
  // Group events by date
  const eventsByDate = {};
  filteredEvents.forEach(event => {
    const eventDate = new Date(event.date);
    if (eventDate.getMonth() === currentMonth && eventDate.getFullYear() === currentYear) {
      const dateKey = eventDate.getDate();
      if (!eventsByDate[dateKey]) {
        eventsByDate[dateKey] = [];
      }
      eventsByDate[dateKey].push(event);
    }
  });
  
  // Get today's date for highlighting
  const today = new Date();
  const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;
  const todayDate = isCurrentMonth ? today.getDate() : null;
  
  // Calculate previous month's last days for padding
  const prevMonth = new Date(currentYear, currentMonth, 0);
  const daysInPrevMonth = prevMonth.getDate();
  
  // Build calendar grid
  let calendarHTML = '';
  
  // Previous month's trailing days
  for (let i = startingDayOfWeek - 1; i >= 0; i--) {
    const day = daysInPrevMonth - i;
    calendarHTML += createCalendarDay(day, true, [], false);
  }
  
  // Current month's days
  for (let day = 1; day <= daysInMonth; day++) {
    const isToday = day === todayDate;
    const dayEvents = eventsByDate[day] || [];
    calendarHTML += createCalendarDay(day, false, dayEvents, isToday);
  }
  
  // Next month's leading days to fill the grid
  const totalCells = startingDayOfWeek + daysInMonth;
  const remainingCells = 42 - totalCells; // 6 rows * 7 days = 42
  for (let day = 1; day <= remainingCells; day++) {
    calendarHTML += createCalendarDay(day, true, [], false);
  }
  
  calendarGrid.innerHTML = calendarHTML;
}

function createCalendarDay(day, isOtherMonth, dayEvents, isToday) {
  const otherMonthClass = isOtherMonth ? 'other-month' : '';
  const todayClass = isToday ? 'today' : '';
  const dayNumberClass = isToday ? 'day-number' : '';
  
  // Limit events shown (max 3 visible, then show "+X more")
  const maxVisible = 3;
  const visibleEvents = dayEvents.slice(0, maxVisible);
  const moreCount = dayEvents.length - maxVisible;
  
  let eventsHTML = visibleEvents.map(event => {
    const typeColors = {
      session: 'session',
      meeting: 'meeting',
      feedback: 'feedback',
      training: 'training'
    };
    const eventTypeClass = typeColors[event.type] || 'session';
    const time = event.start_time ? event.start_time.substring(0, 5) : '';
    const title = escapeHtml(event.title);
    const displayTitle = title.length > 20 ? title.substring(0, 20) + '...' : title;
    return `<div class="calendar-event ${eventTypeClass}" onclick="event.stopPropagation(); viewEvent('${event.id}')" title="${title}${time ? ' at ' + time : ''}">
      ${time ? `${time} ` : ''}${displayTitle}
    </div>`;
  }).join('');
  
  if (moreCount > 0) {
    eventsHTML += `<div class="calendar-event-more" onclick="event.stopPropagation(); showDayEvents(${day}, ${currentMonth}, ${currentYear})">
      +${moreCount} more
    </div>`;
  }
  
  // Make day clickable to create event on that date
  const dateStr = isOtherMonth ? '' : `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
  const onClick = isOtherMonth ? '' : `onclick="createEventOnDate('${dateStr}')"`;
  
  return `
    <div class="calendar-day ${otherMonthClass} ${todayClass}" ${onClick}>
      <div class="calendar-day-number ${dayNumberClass}">${day}</div>
      <div class="calendar-events">
        ${eventsHTML}
      </div>
    </div>
  `;
}

function createEventOnDate(dateStr) {
  const eventType = currentFilter !== 'all' ? currentFilter : null;
  openEventModal(null, eventType);
  // Set the date in the form
  setTimeout(() => {
    const dateInput = document.getElementById('eventDate');
    if (dateInput) {
      dateInput.value = dateStr;
    }
  }, 100);
}

function showDayEvents(day, month, year) {
  // Filter events for this specific day
  let filteredEvents = events;
  if (currentFilter !== 'all') {
    filteredEvents = events.filter(event => event.type === currentFilter);
  }
  
  const targetDate = new Date(year, month, day);
  const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
  
  const dayEvents = filteredEvents.filter(event => {
    const eventDate = new Date(event.date);
    return eventDate.toDateString() === targetDate.toDateString();
  });
  
  if (dayEvents.length === 0) {
    createEventOnDate(dateStr);
    return;
  }
  
  // Show events in a modal or dropdown
  // For now, just show the first event or create new one
  if (dayEvents.length === 1) {
    viewEvent(dayEvents[0].id);
  } else {
    // Could show a list modal here, for now just show first
    viewEvent(dayEvents[0].id);
  }
}

// Database functions
async function loadEvents() {
  try {
    if (!window.supabaseClient) {
      console.error('Supabase client not initialized');
      return;
    }

    // Get current user info to check role
    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
    const currentUserEmail = userInfo.email;
    const isSuperAdmin = userInfo.role === 'Super Admin';

    let query = window.supabaseClient
      .from('events')
      .select('*');

    // If user is not Super Admin, only show their own events
    if (!isSuperAdmin && currentUserEmail) {
      query = query.eq('created_by', currentUserEmail);
    }

    const { data, error } = await query
      .order('date', { ascending: true })
      .order('start_time', { ascending: true });

    if (error) {
      console.error('Error loading events:', error);
      // If table doesn't exist, events will remain empty
      if (error.code === 'PGRST116' || error.message.includes('does not exist')) {
        console.warn('Events table does not exist. Please create it in Supabase.');
      }
      events = [];
      return;
    }

    events = data || [];
  } catch (error) {
    console.error('Error loading events:', error);
    events = [];
  }
}

async function createEvent(eventData) {
  try {
    if (!window.supabaseClient) {
      throw new Error('Supabase client not initialized');
    }

    const { data, error } = await window.supabaseClient
      .from('events')
      .insert([eventData])
      .select()
      .single();

    if (error) {
      // If table doesn't exist, provide helpful error
      if (error.code === 'PGRST116' || error.message.includes('does not exist')) {
        throw new Error('Events table does not exist. Please create it in Supabase first.');
      }
      throw error;
    }

    return data;
  } catch (error) {
    console.error('Error creating event:', error);
    throw error;
  }
}

async function updateEvent(eventId, eventData) {
  try {
    if (!window.supabaseClient) {
      throw new Error('Supabase client not initialized');
    }

    const { data, error } = await window.supabaseClient
      .from('events')
      .update(eventData)
      .eq('id', eventId)
      .select()
      .single();

    if (error) {
      throw error;
    }

    return data;
  } catch (error) {
    console.error('Error updating event:', error);
    throw error;
  }
}

async function deleteEvent(eventId) {
  // Check if user can delete this event
  const event = events.find(e => e.id === eventId);
  if (event) {
    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
    const isSuperAdmin = userInfo.role === 'Super Admin';
    const isOwner = event.created_by === userInfo.email;
    
    if (!isSuperAdmin && !isOwner) {
      if (window.confirmationDialog) {
        await window.confirmationDialog.show({
          title: 'Permission Denied',
          message: 'You can only delete events that you created.',
          confirmText: 'OK',
          cancelText: '',
          type: 'error'
        });
      } else {
      alert('You can only delete events that you created.');
      }
      return;
    }
  }

  // Use confirmation dialog instead of confirm()
  const confirmed = await window.confirmationDialog.show({
    title: 'Delete Event',
    message: 'Are you sure you want to delete this event? This action cannot be undone.',
    confirmText: 'Delete',
    cancelText: 'Cancel',
    type: 'error'
  });

  if (!confirmed) {
    return;
  }

  try {
    if (!window.supabaseClient) {
      throw new Error('Supabase client not initialized');
    }

    const { error } = await window.supabaseClient
      .from('events')
      .delete()
      .eq('id', eventId);

    if (error) {
      throw error;
    }

    await loadEvents();
    renderEvents();
  } catch (error) {
    console.error('Error deleting event:', error);
    if (window.confirmationDialog) {
      await window.confirmationDialog.show({
        title: 'Error',
        message: 'Error deleting event: ' + (error.message || 'Unknown error'),
        confirmText: 'OK',
        cancelText: '',
        type: 'error'
      });
    } else {
    alert('Error deleting event: ' + (error.message || 'Unknown error'));
    }
  }
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Close modals when clicking outside
document.addEventListener('click', function(e) {
  const eventModal = document.getElementById('eventModal');
  const viewModal = document.getElementById('viewEventModal');
  
  if (eventModal && e.target === eventModal) {
    closeEventModal();
  }
  
  if (viewModal && e.target === viewModal) {
    closeViewEventModal();
  }
});
</script>
</body>
</html>